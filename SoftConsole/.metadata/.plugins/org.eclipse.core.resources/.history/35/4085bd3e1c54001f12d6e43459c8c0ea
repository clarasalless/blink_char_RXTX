/*
 * protocol.c
 *
 *  Created on: 23/07/2024
 *      Author: Clara
 */
#include <stdint.h>  // Include this header to define uint8_t
#include "protocol.h"
#include "timer_utils.h"

void protocol_poll(Contexto con, uint8_t data)
{
	uint32_t current_time = get_current_time_ms();

	    // Verificar timeout
	    if ((current_time - con->last_time) > con->timeout) {
	        protocol_flush(con);  // Resetar o estado do protocolo
	    }

	    con->last_time = current_time;  // Atualizar o último tempo de recebimento

	    switch (con->state) {
	        case IDLE:
	            if (data == 0xAA) { // Supondo que 0xAA seja o byte inicial esperado
	                con->state = ID;
	                con->context = data;
	            }
	            break;

	        case ID:
	            con->context = data;
	            con->state = FUNC;
	            break;

	        case FUNC:
	            con->function = data;
	            con->state = DATA;
	            break;

	        case DATA:
	            if (addElement(&con->buffer, data) == -1) {
	                // Buffer cheio, tratar erro conforme necessário
	            }
	            // Checar se todos os dados esperados foram recebidos
	            if (bytesInBuffer(&con->buffer) >= expected_data_length(con)) {
	                con->state = CHECKSUM;
	            }
	            break;

	        case CHECKSUM:
	            if (validate_checksum(con, data)) {
	                // Mensagem completa e checksum válido
	                process_message(con);
	            } else {
	                // Checksum inválido, tratar erro conforme necessário
	            }
	            con->state = IDLE;
	            break;

	        default:
	            con->state = IDLE;
	            break;
	    }
}

void protocol_flush(Contexto con)
{
	con.context = 0;
	con.timeout = 0;
	con.last_time = 0;
}

